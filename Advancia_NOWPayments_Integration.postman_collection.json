{
  "info": {
    "name": "Advancia NOWPayments Integration",
    "description": "Complete API collection for testing NOWPayments integration with Cryptomus comparison",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "advancia-pay"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{auth_token}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:4000",
      "type": "string"
    },
    {
      "key": "auth_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "admin_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "user_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "withdrawal_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Authentication",
      "item": [
        {
          "name": "Login User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('auth_token', response.token);",
                  "    pm.collectionVariables.set('user_id', response.user.id);",
                  "    pm.environment.set('auth_token', response.token);",
                  "    console.log('✅ Token saved:', response.token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login"]
            },
            "description": "Login as regular user to test withdrawal requests"
          },
          "response": []
        },
        {
          "name": "Login Admin",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('admin_token', response.token);",
                  "    pm.environment.set('admin_token', response.token);",
                  "    console.log('✅ Admin token saved:', response.token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@example.com\",\n  \"password\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login"]
            },
            "description": "Login as admin to test withdrawal approvals and processing"
          },
          "response": []
        }
      ]
    },
    {
      "name": "2. Withdrawal Methods",
      "item": [
        {
          "name": "Get Available Payment Providers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status is 200', function() {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Returns both providers', function() {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.true;",
                  "    pm.expect(response.methods).to.be.an('array');",
                  "    pm.expect(response.methods.length).to.equal(2);",
                  "});",
                  "",
                  "pm.test('NOWPayments is recommended', function() {",
                  "    const response = pm.response.json();",
                  "    const nowpayments = response.methods.find(m => m.provider === 'nowpayments');",
                  "    pm.expect(nowpayments.recommended).to.be.true;",
                  "    pm.expect(nowpayments.fees).to.equal('0.5%');",
                  "});",
                  "",
                  "pm.test('Cryptomus details correct', function() {",
                  "    const response = pm.response.json();",
                  "    const cryptomus = response.methods.find(m => m.provider === 'cryptomus');",
                  "    pm.expect(cryptomus.fees).to.equal('1%');",
                  "    pm.expect(cryptomus.processingTime).to.equal('5-30 minutes');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/withdrawals/methods",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "methods"]
            },
            "description": "Fetch available payment providers for withdrawals (Cryptomus vs NOWPayments comparison)"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "GET",
                "header": [],
                "url": {
                  "raw": "{{base_url}}/api/withdrawals/methods",
                  "host": ["{{base_url}}"],
                  "path": ["api", "withdrawals", "methods"]
                }
              },
              "status": "OK",
              "code": 200,
              "_postman_previewlanguage": "json",
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "cookie": [],
              "body": "{\n  \"success\": true,\n  \"methods\": [\n    {\n      \"provider\": \"cryptomus\",\n      \"name\": \"Cryptomus\",\n      \"description\": \"50+ cryptocurrencies supported\",\n      \"currencies\": [\"btc\", \"eth\", \"usdt\", \"bnb\", \"ltc\", \"doge\"],\n      \"minAmount\": 10,\n      \"fees\": \"1%\",\n      \"processingTime\": \"5-30 minutes\",\n      \"features\": [\"Fast processing\", \"Popular currencies\", \"Instant payouts\"]\n    },\n    {\n      \"provider\": \"nowpayments\",\n      \"name\": \"NOWPayments\",\n      \"description\": \"200+ cryptocurrencies supported\",\n      \"currencies\": [\"btc\", \"eth\", \"usdt\", \"trx\", \"ltc\", \"xmr\", \"doge\", \"ada\", \"dot\", \"matic\"],\n      \"minAmount\": 10,\n      \"fees\": \"0.5%\",\n      \"processingTime\": \"10-60 minutes\",\n      \"features\": [\"Lowest fees\", \"Most currencies\", \"Mass payouts\"],\n      \"recommended\": true\n    }\n  ]\n}"
            }
          ]
        }
      ]
    },
    {
      "name": "3. NOWPayments - Payment Info",
      "item": [
        {
          "name": "Get Supported Currencies",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status is 200', function() {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Returns currency list', function() {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.true;",
                  "    pm.expect(response.currencies).to.be.an('array');",
                  "    pm.expect(response.currencies.length).to.be.above(100);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/nowpayments/currencies",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "currencies"]
            },
            "description": "Get list of 200+ supported cryptocurrencies from NOWPayments"
          },
          "response": []
        },
        {
          "name": "Get Minimum Amount",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/nowpayments/min-amount/btc",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "min-amount", "btc"]
            },
            "description": "Get minimum payment amount for specific cryptocurrency"
          },
          "response": []
        },
        {
          "name": "Get Price Estimate",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/nowpayments/estimate?amount=100&currency=btc",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "estimate"],
              "query": [
                {
                  "key": "amount",
                  "value": "100",
                  "description": "USD amount"
                },
                {
                  "key": "currency",
                  "value": "btc",
                  "description": "Target cryptocurrency"
                }
              ]
            },
            "description": "Calculate how much crypto for given USD amount"
          },
          "response": []
        }
      ]
    },
    {
      "name": "4. User - Withdrawal Requests",
      "item": [
        {
          "name": "Request Withdrawal (Cryptomus)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.withdrawal && response.withdrawal.id) {",
                  "        pm.collectionVariables.set('withdrawal_id', response.withdrawal.id);",
                  "        console.log('✅ Withdrawal ID saved:', response.withdrawal.id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"balanceType\": \"btc\",\n  \"amount\": 0.001,\n  \"withdrawalAddress\": \"bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\",\n  \"paymentProvider\": \"cryptomus\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/withdrawals/request",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "request"]
            },
            "description": "Request withdrawal using Cryptomus (1% fees, faster)"
          },
          "response": []
        },
        {
          "name": "Request Withdrawal (NOWPayments)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.withdrawal && response.withdrawal.id) {",
                  "        pm.collectionVariables.set('withdrawal_id', response.withdrawal.id);",
                  "        console.log('✅ Withdrawal ID saved:', response.withdrawal.id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"balanceType\": \"btc\",\n  \"amount\": 0.001,\n  \"withdrawalAddress\": \"bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\",\n  \"paymentProvider\": \"nowpayments\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/withdrawals/request",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "request"]
            },
            "description": "Request withdrawal using NOWPayments (0.5% fees, more coins, recommended)"
          },
          "response": []
        },
        {
          "name": "Get My Withdrawals",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/withdrawals/my-requests",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "my-requests"]
            },
            "description": "Get current user's withdrawal history"
          },
          "response": []
        }
      ]
    },
    {
      "name": "5. Admin - Withdrawal Management",
      "item": [
        {
          "name": "Get All Pending Withdrawals",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/withdrawals/admin/all?status=pending",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "admin", "all"],
              "query": [
                {
                  "key": "status",
                  "value": "pending",
                  "description": "Filter by status"
                }
              ]
            },
            "description": "Admin endpoint - Get all pending withdrawal requests"
          },
          "response": []
        },
        {
          "name": "Get Approved Withdrawals (NOWPayments)",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/withdrawals/admin/all?status=approved&paymentProvider=nowpayments",
              "host": ["{{base_url}}"],
              "path": ["api", "withdrawals", "admin", "all"],
              "query": [
                {
                  "key": "status",
                  "value": "approved"
                },
                {
                  "key": "paymentProvider",
                  "value": "nowpayments"
                }
              ]
            },
            "description": "Filter approved withdrawals by NOWPayments provider for batch processing"
          },
          "response": []
        },
        {
          "name": "Approve Withdrawal",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"adminNotes\": \"Verified user identity and wallet address\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/withdrawals/admin/{{withdrawal_id}}/approve",
              "host": ["{{base_url}}"],
              "path": [
                "api",
                "withdrawals",
                "admin",
                "{{withdrawal_id}}",
                "approve"
              ]
            },
            "description": "Approve a withdrawal request (sets status to 'approved')"
          },
          "response": []
        },
        {
          "name": "Reject Withdrawal",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"adminNotes\": \"Invalid wallet address format\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/withdrawals/admin/{{withdrawal_id}}/reject",
              "host": ["{{base_url}}"],
              "path": [
                "api",
                "withdrawals",
                "admin",
                "{{withdrawal_id}}",
                "reject"
              ]
            },
            "description": "Reject a withdrawal request with reason"
          },
          "response": []
        }
      ]
    },
    {
      "name": "6. Admin - NOWPayments Processing",
      "item": [
        {
          "name": "Check Merchant Balance",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/nowpayments/balance",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "balance"]
            },
            "description": "Check NOWPayments merchant account balance before processing withdrawals"
          },
          "response": []
        },
        {
          "name": "Process Withdrawals (Batch Payout)",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{admin_token}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"withdrawalIds\": [\n    \"withdrawal-id-1\",\n    \"withdrawal-id-2\",\n    \"withdrawal-id-3\"\n  ]\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/nowpayments/process-withdrawals",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "process-withdrawals"]
            },
            "description": "Send approved NOWPayments withdrawals as batch payout. Updates status to 'processing' and stores batch ID."
          },
          "response": []
        }
      ]
    },
    {
      "name": "7. Webhooks (Testing)",
      "item": [
        {
          "name": "NOWPayments Payout IPN (Mock)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-nowpayments-sig",
                "value": "mock-signature",
                "description": "HMAC-SHA512 signature (will fail verification in real setup)"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": \"5000000000\",\n  \"batch_withdrawal_id\": \"5000000713\",\n  \"status\": \"FINISHED\",\n  \"address\": \"bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\",\n  \"currency\": \"btc\",\n  \"amount\": \"0.001\",\n  \"hash\": \"0xabc123def456\",\n  \"unique_external_id\": \"withdrawal-id-1\",\n  \"created_at\": \"2025-11-22T12:00:00Z\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/nowpayments/payout-ipn",
              "host": ["{{base_url}}"],
              "path": ["api", "nowpayments", "payout-ipn"]
            },
            "description": "Mock webhook from NOWPayments when payout completes (signature verification will fail unless you generate valid HMAC)"
          },
          "response": []
        }
      ]
    }
  ]
}
