name: Render Rollback

on:
  workflow_dispatch:
    inputs:
      restore_to_deploy_id:
        description: 'Optional: provide a deploy ID to roll back to. If omitted, the last successful deploy will be used.'
        required: false
        type: string
      environment:
        description: 'Target environment for rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      confirm_rollback:
        description: 'Type "CONFIRM" to proceed with rollback'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Validate inputs and secrets
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          # Validate confirmation
          if [ "${{ github.event.inputs.confirm_rollback }}" != "CONFIRM" ]; then
            echo "âŒ Rollback not confirmed. Please type 'CONFIRM' to proceed." >&2
            exit 1
          fi
          
          # Validate secrets
          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "âŒ RENDER_API_KEY and RENDER_SERVICE_ID are required secrets. Aborting." >&2
            exit 1
          fi
          
          # Validate deploy ID format if provided
          if [ -n "${{ github.event.inputs.restore_to_deploy_id }}" ]; then
            if ! [[ "${{ github.event.inputs.restore_to_deploy_id }}" =~ ^[a-f0-9]{24}$ ]]; then
              echo "âŒ Invalid deploy ID format. Must be a 24-character hexadecimal string." >&2
              exit 1
            fi
          fi
          
          echo "âœ… Input validation passed"

      - name: Determine deploy to roll back to
        id: select_deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -n "${{ github.event.inputs.restore_to_deploy_id }}" ]; then
            DEPLOY_ID="${{ github.event.inputs.restore_to_deploy_id }}"
            echo "ğŸ” Validating provided deploy ID: $DEPLOY_ID"
            
            # Verify the deploy exists and is successful
            VERIFY_RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID")
            
            HTTP_STATUS=$(echo "$VERIFY_RESP" | grep "HTTP_STATUS:" | cut -d: -f2)
            BODY=$(echo "$VERIFY_RESP" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              STATUS=$(echo "$BODY" | jq -r .state 2>/dev/null)
              if [ "$STATUS" != "succeeded" ]; then
                echo "âŒ Deploy $DEPLOY_ID is not in 'succeeded' state (current: $STATUS)" >&2
                exit 1
              fi
              echo "âœ… Deploy $DEPLOY_ID validated successfully"
            else
              echo "âŒ Deploy $DEPLOY_ID not found or inaccessible" >&2
              exit 1
            fi
            
            echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ” Finding last successful deploy..."
          RESP=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=20")
          
          DEPLOY_ID=$(echo "$RESP" | jq -r '.[] | select(.state=="succeeded") | .id' | head -n 1)
          
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "âŒ No successful deploy found to rollback to." >&2
            exit 1
          fi
          
          DEPLOY_COMMIT=$(echo "$RESP" | jq -r ".[] | select(.id==\"$DEPLOY_ID\") | .commit")
          echo "âœ… Found deploy: $DEPLOY_ID (commit: ${DEPLOY_COMMIT:0:7})"
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      - name: Trigger rollback deploy
        id: trigger_rollback
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          DEPLOY_ID=${{ steps.select_deploy.outputs.deploy_id }}
          echo "ğŸš€ Triggering rollback to deploy: $DEPLOY_ID"
          
          # Trigger the redeploy
          RESP=$(curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -d '{}' \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID/redeploy")
          
          HTTP_STATUS=$(echo "$RESP" | grep "HTTP_STATUS:" | cut -d: -f2)
          BODY=$(echo "$RESP" | sed '/HTTP_STATUS:/d')
          
          if [ "$HTTP_STATUS" -eq 201 ]; then
            echo "âœ… Rollback deploy triggered successfully"
            echo "$BODY" | jq . 2>/dev/null || echo "Response: $BODY"
            RUN_ID=$(echo "$BODY" | jq -r .id 2>/dev/null)
            
            if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
              echo "âŒ Failed to get run ID from response" >&2
              exit 1
            fi
            
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Redeploy request failed with status $HTTP_STATUS"
            echo "Response: $BODY" >&2
            exit 1
          fi

      - name: Poll redeploy status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          RUN_ID=${{ steps.trigger_rollback.outputs.run_id }}
          MAX_ATTEMPTS=120  # 20 minutes with 10s intervals
          ATTEMPT=1
          
          echo "â³ Monitoring rollback deploy: $RUN_ID"
          echo "Timeout: $((MAX_ATTEMPTS * 10 / 60)) minutes"
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "[$ATTEMPT/$MAX_ATTEMPTS] Checking deploy status..."
            
            STATUS_RESP=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              -w "\nHTTP_STATUS:%{http_code}" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$RUN_ID")
            
            HTTP_STATUS=$(echo "$STATUS_RESP" | grep "HTTP_STATUS:" | cut -d: -f2)
            BODY=$(echo "$STATUS_RESP" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              STATUS=$(echo "$BODY" | jq -r .state 2>/dev/null)
              echo "Status: $STATUS"
              
              case $STATUS in
                "succeeded")
                  echo "âœ… Rollback deploy completed successfully!"
                  exit 0
                  ;;
                "failed")
                  echo "âŒ Rollback deploy failed"
                  echo "Error details:" >&2
                  echo "$BODY" | jq -r .error 2>/dev/null || echo "$BODY" >&2
                  exit 1
                  ;;
                "running"|"pending")
                  echo "â³ Deploy still in progress..."
                  ;;
                *)
                  echo "âš ï¸  Unknown status: $STATUS"
                  ;;
              esac
            else
              echo "âŒ Failed to get deploy status (HTTP $HTTP_STATUS): $BODY" >&2
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "â° Timed out waiting for rollback deploy to complete after $((MAX_ATTEMPTS * 10 / 60)) minutes" >&2
          exit 1

      - name: Rollback Summary
        if: always()
        run: |
          echo "## ğŸš€ Render Rollback Summary"
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}"
          echo "- **Deploy ID**: ${{ steps.select_deploy.outputs.deploy_id }}"
          echo "- **Run ID**: ${{ steps.trigger_rollback.outputs.run_id }}"
          echo "- **Triggered by**: ${{ github.actor }}"
          echo "- **Timestamp**: $(date -u)"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status**: âœ… Successful"
            echo "ğŸ‰ Rollback completed successfully!"
          else
            echo "- **Status**: âŒ Failed"
            echo "âš ï¸  Rollback failed. Check logs above for details."
          fi
