name: Backup and Run Migrations

on:
  workflow_dispatch:

jobs:
  backup-and-migrate:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pg client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create DB backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "${DATABASE_URL:-}" ]; then
            echo "DATABASE_URL secret is required to create a backup. Aborting."
            exit 1
          fi
          echo "Creating pg_dump backup..."
          pg_dump "$DATABASE_URL" -F c -b -v -f backup.dump

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: backup.dump

      - name: Trigger Render migration job
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_MIGRATION_JOB_ID: ${{ secrets.RENDER_MIGRATION_JOB_ID }}
        run: |
          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ] || [ -z "${RENDER_MIGRATION_JOB_ID:-}" ]; then
            echo "RENDER_API_KEY, RENDER_SERVICE_ID and RENDER_MIGRATION_JOB_ID secrets are required. Aborting."
            exit 1
          fi
          echo "Triggering Render job: $RENDER_MIGRATION_JOB_ID"
          # Trigger a job run for the specified job id. Render's API surface may change; verify the job-run endpoint in your account.
          RESP=$(curl -s -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/jobs/$RENDER_MIGRATION_JOB_ID/runs)
          echo "$RESP" > run.json
          echo "Trigger response: $RESP"
          RUN_ID=$(echo "$RESP" | jq -r .id)
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "Failed to start Render job. See run.json for details." >&2
            cat run.json
            exit 2
          fi
          echo "Started run: $RUN_ID"

      - name: Wait for migration run to complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_MIGRATION_JOB_ID: ${{ secrets.RENDER_MIGRATION_JOB_ID }}
        run: |
          # Poll the run status until success or failure (timeout after ~15 minutes)
          RUN_ID=$(jq -r .id run.json)
          echo "Polling run id: $RUN_ID"
          for i in $(seq 1 90); do
            STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              https://api.render.com/v1/services/$RENDER_SERVICE_ID/jobs/$RENDER_MIGRATION_JOB_ID/runs/$RUN_ID | jq -r .status)
            echo "[$i] status=$STATUS"
            if [ "$STATUS" = "succeeded" ] || [ "$STATUS" = "success" ]; then
              echo "Migration run succeeded."
              exit 0
            fi
            if [ "$STATUS" = "failed" ]; then
              echo "Migration run failed." >&2
              exit 2
            fi
            sleep 10
          done
          echo "Timed out waiting for migration run to complete." >&2
          exit 3

      - name: Health check
        run: |
          # Adjust the URL to your production health endpoint
          HEALTH_URL="https://api.advanciapayledger.com/health"
          echo "Checking health: $HEALTH_URL"
          for i in $(seq 1 12); do
            if curl -fsS "$HEALTH_URL"; then
              echo "Health check OK"
              exit 0
            fi
            echo "Health check failed, retrying..."
            sleep 5
          done
          echo "Health check failed after migration." >&2
          exit 4
