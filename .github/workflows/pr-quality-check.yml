name: âœ… PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - staging

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  duplicate-check:
    name: Check for duplicate PRs
    runs-on: ubuntu-latest
    steps:
      - name: Check for duplicate PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: context.payload.pull_request.base.ref
            });

            const currentPR = context.payload.pull_request;
            const duplicates = pulls.filter(pr => 
              pr.number !== currentPR.number &&
              pr.head.ref === currentPR.head.ref
            );

            if (duplicates.length > 0) {
              const duplicateLinks = duplicates.map(pr => `#${pr.number}`).join(', ');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentPR.number,
                body: `âš ï¸ **Duplicate PR detected!**\n\nThis PR appears to be a duplicate of: ${duplicateLinks}\n\nPlease close duplicate PRs to avoid confusion.`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentPR.number,
                labels: ['duplicate']
              });
            }

  lint-and-format:
    name: Code Quality Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.workspace }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.workspace }}
        run: npm ci

      - name: Run linter
        working-directory: ${{ matrix.workspace }}
        run: npm run lint --if-present || echo "No lint script found"

      - name: Check TypeScript types
        working-directory: ${{ matrix.workspace }}
        run: npm run type-check || npx tsc --noEmit

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.workspace }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.workspace }}
        run: npm ci

      - name: Build project
        working-directory: ${{ matrix.workspace }}
        run: npm run build

      - name: Comment build success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const workspace = '${{ matrix.workspace }}';
            const body = `âœ… **${workspace.charAt(0).toUpperCase() + workspace.slice(1)} build successful!**`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.data.find(c => 
              c.user.type === 'Bot' && c.body.includes(`${workspace.charAt(0).toUpperCase() + workspace.slice(1)} build`)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

  test-check:
    name: Test Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.workspace }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.workspace }}
        run: npm ci

      - name: Run tests
        working-directory: ${{ matrix.workspace }}
        run: npm test --if-present || echo "No tests found"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          if git grep -i 'sk_live_\|pk_live_' -- '*.ts' '*.tsx' '*.js' '*.jsx' | grep -v 'test\|mock'; then
            echo "âŒ Production secrets found in code!"
            exit 1
          else
            echo "âœ… No hardcoded production secrets found"
          fi

      - name: Run npm audit
        run: |
          cd backend && npm audit --audit-level=moderate || true
          cd ../frontend && npm audit --audit-level=moderate || true

      - name: Check for TODO/FIXME
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const { data: diff } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });

            const patch = diff.files.map(f => f.patch || '').join('\n');
            const todoCount = (patch.match(/TODO|FIXME/g) || []).length;

            if (todoCount > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `âš ï¸ **${todoCount} TODO/FIXME comment(s) added**\n\nConsider creating follow-up issues for these items.`
              });
            }

  pr-summary:
    name: Generate PR Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-check, test-check, security-scan]
    if: always()
    steps:
      - name: Create summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = ${{ toJSON(needs) }};
            let summary = '## ğŸ¤– PR Quality Check Summary\n\n';

            const statuses = {
              'lint-and-format': 'ğŸ¨ Code Quality',
              'build-check': 'ğŸ”¨ Build',
              'test-check': 'ğŸ§ª Tests',
              'security-scan': 'ğŸ”’ Security'
            };

            for (const [job, status] of Object.entries(statuses)) {
              const result = jobs[job]?.result || 'unknown';
              const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'â­ï¸';
              summary += `- ${emoji} ${status}: ${result}\n`;
            }

            summary += '\n---\n';
            summary += '**Next steps:**\n';
            summary += '1. Address any failed checks above\n';
            summary += '2. Request review from appropriate team members\n';
            summary += '3. Ensure all conversations are resolved\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });
