name: Render Backup Job

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # run daily at 02:00 UTC

jobs:
  trigger-render-backup:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Validate secrets
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_BACKUP_JOB_ID: ${{ secrets.RENDER_BACKUP_JOB_ID }}
        run: |
          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ] || [ -z "${RENDER_BACKUP_JOB_ID:-}" ]; then
            echo "RENDER_API_KEY, RENDER_SERVICE_ID, RENDER_BACKUP_JOB_ID are required secrets. Aborting." >&2
            exit 1
          fi

      - name: Trigger Render backup job
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_BACKUP_JOB_ID: ${{ secrets.RENDER_BACKUP_JOB_ID }}
        run: |
          RESP=$(curl -s -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/jobs/$RENDER_BACKUP_JOB_ID/runs)
          echo "$RESP" | jq . > run.json
          RUN_ID=$(jq -r .id run.json)
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "Failed to start Render backup job." >&2
            exit 2
          fi
          echo "Started Render backup job: $RUN_ID"

      - name: Poll backup job status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_BACKUP_JOB_ID: ${{ secrets.RENDER_BACKUP_JOB_ID }}
        run: |
          RUN_ID=$(jq -r .id run.json) || true
          echo "Polling run id: $RUN_ID"
          for i in $(seq 1 90); do
            STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              https://api.render.com/v1/services/$RENDER_SERVICE_ID/jobs/$RENDER_BACKUP_JOB_ID/runs/$RUN_ID | jq -r .status)
            echo "[$i] status=$STATUS"
            if [ "$STATUS" = "succeeded" ] || [ "$STATUS" = "success" ]; then
              echo "Backup run succeeded."
              exit 0
            fi
            if [ "$STATUS" = "failed" ]; then
              echo "Backup run failed." >&2
              exit 2
            fi
            sleep 10
          done
          echo "Timed out waiting for backup run to complete." >&2
          exit 3